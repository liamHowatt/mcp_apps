#include "beeper_ui_private.h"

LV_IMAGE_DECLARE(beeper_ui_sas_emoji_0);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_1);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_2);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_3);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_4);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_5);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_6);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_7);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_8);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_9);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_10);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_11);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_12);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_13);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_14);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_15);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_16);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_17);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_18);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_19);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_20);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_21);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_22);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_23);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_24);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_25);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_26);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_27);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_28);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_29);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_30);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_31);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_32);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_33);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_34);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_35);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_36);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_37);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_38);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_39);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_40);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_41);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_42);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_43);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_44);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_45);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_46);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_47);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_48);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_49);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_50);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_51);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_52);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_53);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_54);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_55);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_56);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_57);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_58);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_59);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_60);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_61);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_62);
LV_IMAGE_DECLARE(beeper_ui_sas_emoji_63);
static const lv_image_dsc_t * const emoji_table[64] = {
    &beeper_ui_sas_emoji_0,
    &beeper_ui_sas_emoji_1,
    &beeper_ui_sas_emoji_2,
    &beeper_ui_sas_emoji_3,
    &beeper_ui_sas_emoji_4,
    &beeper_ui_sas_emoji_5,
    &beeper_ui_sas_emoji_6,
    &beeper_ui_sas_emoji_7,
    &beeper_ui_sas_emoji_8,
    &beeper_ui_sas_emoji_9,
    &beeper_ui_sas_emoji_10,
    &beeper_ui_sas_emoji_11,
    &beeper_ui_sas_emoji_12,
    &beeper_ui_sas_emoji_13,
    &beeper_ui_sas_emoji_14,
    &beeper_ui_sas_emoji_15,
    &beeper_ui_sas_emoji_16,
    &beeper_ui_sas_emoji_17,
    &beeper_ui_sas_emoji_18,
    &beeper_ui_sas_emoji_19,
    &beeper_ui_sas_emoji_20,
    &beeper_ui_sas_emoji_21,
    &beeper_ui_sas_emoji_22,
    &beeper_ui_sas_emoji_23,
    &beeper_ui_sas_emoji_24,
    &beeper_ui_sas_emoji_25,
    &beeper_ui_sas_emoji_26,
    &beeper_ui_sas_emoji_27,
    &beeper_ui_sas_emoji_28,
    &beeper_ui_sas_emoji_29,
    &beeper_ui_sas_emoji_30,
    &beeper_ui_sas_emoji_31,
    &beeper_ui_sas_emoji_32,
    &beeper_ui_sas_emoji_33,
    &beeper_ui_sas_emoji_34,
    &beeper_ui_sas_emoji_35,
    &beeper_ui_sas_emoji_36,
    &beeper_ui_sas_emoji_37,
    &beeper_ui_sas_emoji_38,
    &beeper_ui_sas_emoji_39,
    &beeper_ui_sas_emoji_40,
    &beeper_ui_sas_emoji_41,
    &beeper_ui_sas_emoji_42,
    &beeper_ui_sas_emoji_43,
    &beeper_ui_sas_emoji_44,
    &beeper_ui_sas_emoji_45,
    &beeper_ui_sas_emoji_46,
    &beeper_ui_sas_emoji_47,
    &beeper_ui_sas_emoji_48,
    &beeper_ui_sas_emoji_49,
    &beeper_ui_sas_emoji_50,
    &beeper_ui_sas_emoji_51,
    &beeper_ui_sas_emoji_52,
    &beeper_ui_sas_emoji_53,
    &beeper_ui_sas_emoji_54,
    &beeper_ui_sas_emoji_55,
    &beeper_ui_sas_emoji_56,
    &beeper_ui_sas_emoji_57,
    &beeper_ui_sas_emoji_58,
    &beeper_ui_sas_emoji_59,
    &beeper_ui_sas_emoji_60,
    &beeper_ui_sas_emoji_61,
    &beeper_ui_sas_emoji_62,
    &beeper_ui_sas_emoji_63
};

static void sas_matches_cb(lv_event_t * e)
{
    beeper_ui_t * c = lv_event_get_user_data(e);
    beeper_task_sas_matches(c->task);
}

static void observer_cb(lv_observer_t * observer, lv_subject_t * subject)
{
    lv_obj_t * body = lv_observer_get_target_obj(observer);
    beeper_ui_t * c = lv_observer_get_user_data(observer);

    beeper_ui_verification_status_t verification_status = lv_subject_get_int(&c->verification_status_subject);
    if(verification_status == BEEPER_UI_VERIFICATION_STATUS_UNKNOWN) {
        lv_obj_clean(body);
        lv_obj_t * spinner = lv_spinner_create(body);
        lv_obj_center(spinner);
        lv_obj_set_width(spinner, LV_PCT(40));
    }
    else if(verification_status == BEEPER_UI_VERIFICATION_STATUS_VERIFIED) {
        lv_obj_t * bg_cont = lv_obj_get_parent(body);
        lv_obj_t * base_obj = lv_obj_get_parent(bg_cont);
        lv_obj_delete(bg_cont);
        beeper_ui_texter(base_obj);
    }
    else if(verification_status == BEEPER_UI_VERIFICATION_STATUS_NOT_VERIFIED) {
        lv_obj_clean(body);
        const uint8_t * sas_emojis = lv_subject_get_pointer(&c->sas_emoji_subject);
        if(sas_emojis) {
            lv_obj_set_flex_flow(body, LV_FLEX_FLOW_ROW_WRAP);
            for(int i = 0; i < 7; i++) {
                lv_obj_t * emoji = lv_image_create(body);
                lv_image_set_src(emoji, emoji_table[sas_emojis[i]]);
            }
            lv_obj_t * label = lv_label_create(body);
            lv_obj_add_flag(label, LV_OBJ_FLAG_FLEX_IN_NEW_TRACK);
            lv_label_set_text_static(label, "Do they match?");
            lv_obj_t * btn = lv_button_create(body);
            lv_obj_add_flag(btn, LV_OBJ_FLAG_FLEX_IN_NEW_TRACK);
            lv_obj_t * btn_label = lv_label_create(btn);
            lv_label_set_text_static(btn_label, "Yes");
            lv_obj_add_event_cb(btn, sas_matches_cb, LV_EVENT_CLICKED, c);
        }
        else {
            lv_obj_t * label = lv_label_create(body);
            lv_label_set_text_static(label, "This device is not verified. Initiate verification from another device.");
            lv_obj_set_width(label, LV_PCT(90));
            lv_obj_center(label);
        }
    }
}

void beeper_ui_verify(lv_obj_t * base_obj)
{
    beeper_ui_t * c = lv_obj_get_user_data(base_obj);

    lv_obj_t * bg_cont = lv_obj_create(base_obj);
    lv_obj_remove_style_all(bg_cont);
    lv_obj_set_size(bg_cont, LV_PCT(100), LV_PCT(100));
    lv_obj_set_flex_flow(bg_cont, LV_FLEX_FLOW_COLUMN);

    lv_obj_t * verify_label = lv_label_create(bg_cont);
    lv_label_set_text_static(verify_label, "Verify");

    lv_obj_t * body = lv_obj_create(bg_cont);
    lv_obj_remove_style_all(body);
    lv_obj_set_width(body, LV_PCT(100));
    lv_obj_set_flex_grow(body, 1);

    lv_subject_add_observer_obj(&c->verification_status_subject, observer_cb, body, c);
    lv_subject_add_observer_obj(&c->sas_emoji_subject, observer_cb, body, c);
}
